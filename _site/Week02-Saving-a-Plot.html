<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Chris Papalia" />


<title>Week 02 - Saving Plots</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">AC Plus - Spring 2020</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Week 1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Week01-Intro.html">Week 1</a>
    </li>
    <li>
      <a href="Week01-Intro-janitor-fix.html">Week 1 (Fix)</a>
    </li>
  </ul>
</li>
<li>
  <a href="Week02-Saving-a-Plot.html">Week 2</a>
</li>
<li>
  <a href="Week03-apple-mobility-tracker.html">Week 3</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Week 02 - Saving Plots</h1>
<h4 class="author">Chris Papalia</h4>
<h4 class="date">4/23/2020</h4>

</div>


<p>Today we will create a plot using the deaths data, and then save the plot as a .png file to upload to Edsby. Hopefully things went reasonably well last week with adding to the plots. If you added more, or changed, counties, you now have a plot of your own.</p>
<p>Let’s save a plot:</p>
<div id="saving-a-plot-in-r" class="section level1">
<h1>Saving a Plot in R</h1>
<div id="load-libraries-and-set-a-theme" class="section level3">
<h3>1. Load Libraries and Set a Theme</h3>
<p>We will need to use a new package today, so you’ll need to install the tibbletime package to allow us to use a folling mean function.</p>
<p><strong>In the console, please type: install.packages(“tibbletime”) and run the command.</strong></p>
<p>In order to work with R, you’ll need access to many different packages that allow the user to use different tools. Each of these packages below has a function. Most importantly, the tidyverse package allows the user to import, tidy, transform, and visualize data using commands that are relatively intuitive.</p>
<p>The other packages each perform some function in this module.</p>
<pre class="r"><code>library(tidyverse)
library(janitor)
library(lubridate)
library(ggrepel)
library(knitr)
library(tibbletime)</code></pre>
<p>I have set the theme to light to avoid the gray background in graphics.</p>
<pre class="r"><code>theme_set(theme_light())</code></pre>
</div>
<div id="load-the-deaths-data-in-r" class="section level3">
<h3>2. Load the Deaths data in R</h3>
<p>We will load the data using the data source of the following website <a href="https://coronavirus.jhu.edu/map.html">Johns Hopkins CSSE Map</a></p>
<p>In order to get the data, we will use a link to the Johns Hopkins CSSE data in GitHub. The following command will load the data for us using the <code>read_csv</code> command.</p>
<pre class="r"><code>covid_deaths &lt;- read_csv(&quot;https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv&quot;)</code></pre>
<p>Once you run this line of code, you should see the <code>covid_deaths</code> object in the Environment pane. If you click the object in the environment pane, you can view the data in a tabel format in the <em>Source</em> pane in the upper left.</p>
<div id="a.-clean-the-names" class="section level4">
<h4>A. Clean the names</h4>
<p>Use the viewer to inspect the data and you’ll see we have the same issue that we had last time, so we’ll use the same process as last time to convert the data into a usuable (<strong>tidy</strong>) format. Remember, tidy data has one row that represents a single observation. Each row will represent a single day’s number of deaths in a single country.</p>
<p>We would pefer to use <em>YYYY-MM-DD</em> as our date input, so we will use the following command to rename the columns with the dates formatted correctly.</p>
<pre class="r"><code>old_names_deaths &lt;- colnames(covid_deaths)[5:ncol(covid_deaths)]
new_names_deaths &lt;- parse_date(colnames(covid_deaths)[5:ncol(covid_deaths)], &quot;%m/%d/%y&quot;)

covid_deaths&lt;- covid_deaths %&gt;% 
  rename_at(vars(old_names_deaths), function(x) new_names_deaths)</code></pre>
<pre><code>## Note: Using an external vector in selections is ambiguous.
## i Use `all_of(old_names_deaths)` instead of `old_names_deaths` to silence this message.
## i See &lt;https://tidyselect.r-lib.org/reference/faq-external-vector.html&gt;.
## This message is displayed once per session.</code></pre>
</div>
<div id="b.-re-shape-the-data" class="section level4">
<h4>B. Re-shape the Data</h4>
<p>Then we will reshape the data into a long <em>tidy</em> format using the <code>pivot_longer()</code> command. Now for each country observation (row), we will move the dates under the country. We will call this new dataset <code>covid_deaths_tidy</code>. You can inspect it in the environment to see how it looks different from the <code>covid_deaths</code> that we input from GitHub.</p>
<p>We’ll also assume the <code>janitor</code> package is still broken in the</p>
<pre class="r"><code>covid_deaths_tidy &lt;- covid_deaths %&gt;% 
  pivot_longer(
    cols = -`Province/State`:-Long,  
    names_to = &quot;date&quot;, 
    values_to = &quot;deaths&quot;
  ) %&gt;% as_tibble() %&gt;% 
  mutate(date = as.Date(date)) %&gt;% 
  set_names(tolower(make.names(names(.)))) # The janitor package was broken in the cloud, here is the fix</code></pre>
</div>
<div id="c.-rank-by-deaths" class="section level4">
<h4>C. Rank by deaths</h4>
<table>
<thead>
<tr class="header">
<th align="left">Country</th>
<th align="right">deaths</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">US</td>
<td align="right">58355</td>
</tr>
<tr class="even">
<td align="left">Italy</td>
<td align="right">27359</td>
</tr>
<tr class="odd">
<td align="left">Spain</td>
<td align="right">23822</td>
</tr>
<tr class="even">
<td align="left">United Kingdom</td>
<td align="right">21678</td>
</tr>
<tr class="odd">
<td align="left">Belgium</td>
<td align="right">7331</td>
</tr>
<tr class="even">
<td align="left">Germany</td>
<td align="right">6314</td>
</tr>
<tr class="odd">
<td align="left">Iran</td>
<td align="right">5877</td>
</tr>
<tr class="even">
<td align="left">Brazil</td>
<td align="right">5083</td>
</tr>
<tr class="odd">
<td align="left">Netherlands</td>
<td align="right">4566</td>
</tr>
<tr class="even">
<td align="left">China</td>
<td align="right">4512</td>
</tr>
<tr class="odd">
<td align="left">Turkey</td>
<td align="right">2992</td>
</tr>
<tr class="even">
<td align="left">Sweden</td>
<td align="right">2355</td>
</tr>
<tr class="odd">
<td align="left">Switzerland</td>
<td align="right">1699</td>
</tr>
<tr class="even">
<td align="left">Canada</td>
<td align="right">1683</td>
</tr>
<tr class="odd">
<td align="left">Mexico</td>
<td align="right">1569</td>
</tr>
<tr class="even">
<td align="left">Ireland</td>
<td align="right">1159</td>
</tr>
<tr class="odd">
<td align="left">India</td>
<td align="right">1008</td>
</tr>
<tr class="even">
<td align="left">Portugal</td>
<td align="right">948</td>
</tr>
<tr class="odd">
<td align="left">Ecuador</td>
<td align="right">871</td>
</tr>
<tr class="even">
<td align="left">Russia</td>
<td align="right">867</td>
</tr>
</tbody>
</table>
<p>To create a plot that has the names of the countries with the most deaths, we will assign the names to a list called <code>top_20</code>, where we will call on it to produce a plot.</p>
</div>
</div>
<div id="creating-a-plot" class="section level2">
<h2>Creating a Plot</h2>
</div>
</div>
<div id="a.-create-a-top-20-list" class="section level1">
<h1>A. Create a Top 20 List</h1>
<pre class="r"><code>top_15 &lt;- 
covid_deaths_tidy %&gt;%
  group_by(country.region) %&gt;% 
  summarise(deaths = max(deaths)) %&gt;%
  filter(country.region != &quot;France&quot;) %&gt;% 
  filter(country.region != &quot;China&quot;) %&gt;% 
  arrange(desc(deaths)) %&gt;% 
  slice(1:15) </code></pre>
</div>
<div id="b.-creating-a-daily_deaths-count" class="section level1">
<h1>B. Creating a daily_deaths count</h1>
<pre class="r"><code>covid_daily_deaths &lt;- 
covid_deaths_tidy %&gt;%
  filter(country.region != &quot;France&quot;) %&gt;% 
  group_by(country.region, date) %&gt;%
  summarise(deaths = max(deaths)) %&gt;% 
  mutate(daily_deaths = c(deaths[1], diff(deaths))) %&gt;%
  filter(daily_deaths &gt;= 10) %&gt;% 
  mutate(days = 1:n()) %&gt;% 
  mutate(label = if_else(days == max(days), 
                         country.region, 
                         NA_character_)) %&gt;%
  ungroup() </code></pre>
</div>
<div id="c.-creating-a-rolling-average-for-the-daily-deaths-to-smooth-out-spikes" class="section level1">
<h1>C. Creating a “Rolling Average” for the daily deaths to smooth out spikes</h1>
<p>Remember that you must have installed the <code>tibbletime</code> package and also loaded it in the library.</p>
<pre class="r"><code>roll_mean_5 &lt;- rollify(mean, window = 5) # Create a 5-day rolling average


covid_daily_deaths %&gt;% 
  filter(country.region %in% top_15$country.region) %&gt;%
  group_by(country.region) %&gt;% 
  mutate(deaths_avg = roll_mean_5(daily_deaths)) %&gt;% 
  ungroup() %&gt;% 
  filter(!is.na(deaths_avg)) %&gt;% 
  ggplot(aes(days, deaths_avg, colour = country.region))+
  geom_line(size = .75)+
  geom_text_repel(aes(label = label), 
                  nudge_x = 1, 
                  na.rm = TRUE)+
  scale_y_log10(labels = scales::comma_format())+
  scale_color_discrete(name = &quot;Country&quot;)+
  theme(legend.position = &quot;none&quot;)+
  labs(title = &quot;Have we Reached the Peak of COVID-19?&quot;, 
       x = &quot;Days Since 10 Daily Deaths&quot;,
       y = &quot;Number of Deaths Each Day&quot;,
       subtitle = &quot;5-Day Moving Average of Deaths\nData: Johns Hopkins CSSE&quot;,
       caption = &quot;Inspiration: John Burn Murdoch, FT\nEric Green, Duke&quot;)</code></pre>
<p><img src="Week02-Saving-a-Plot_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
</div>
<div id="save-your-plot" class="section level1">
<h1>Save your Plot</h1>
<p>In order to save your plot, you have two choices. Firstly, you can save it using the viewer pane in the lower right.</p>
<div class="figure">
<img src="plot_pane.png" alt="See the Plots pane “Export” button" />
<p class="caption">See the Plots pane “Export” button</p>
</div>
<p>Once you click the <em>Export</em> button, you can change a variety of options about the plots.</p>
<div class="figure">
<img src="saving_plot_using_plot_pane.png" alt="Choose aspect ratios and file names and types" />
<p class="caption">Choose aspect ratios and file names and types</p>
</div>
<p>Alternatively, you can choose to save your plot using code by assigning your plot to an object, and then using the <code>ggsave()</code> command to save it. See below:</p>
<pre class="r"><code>plot_1 &lt;-
covid_daily_deaths %&gt;% 
  filter(country.region %in% top_15$country.region) %&gt;%
  group_by(country.region) %&gt;% 
  mutate(deaths_avg = roll_mean_5(daily_deaths)) %&gt;% 
  ungroup() %&gt;% 
  filter(!is.na(deaths_avg)) %&gt;% 
  ggplot(aes(days, deaths_avg, colour = country.region))+
  geom_line(size = .75)+
  geom_text_repel(aes(label = label), 
                  nudge_x = 1, 
                  na.rm = TRUE)+
  scale_y_log10(labels = scales::comma_format())+
  scale_color_discrete(name = &quot;Country&quot;)+
  theme(legend.position = &quot;none&quot;)+
  labs(title = &quot;Have we Reached the Peak of COVID-19?&quot;, 
       x = &quot;Days Since 10 Daily Deaths Recorded&quot;,
       y = &quot;Number of Deaths Each Day&quot;,
       subtitle = &quot;5-Day Moving Average of Deaths\nData: Johns Hopkins CSSE&quot;,
       caption = &quot;Inspiration: John Burn Murdoch, FT\nEric Green, Duke&quot;)

ggsave(&quot;plot_save_example.png&quot;, plot = plot_1, height = 5, width = 7)</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
